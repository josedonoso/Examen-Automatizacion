name: CI Automatización de Pruebas

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # === STAGE 1: BUILD ===
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Compilar proyecto (mvn package -DskipTests)
        run: mvn -B package -DskipTests
      - name: Guardar artefacto compilado
        uses: actions/upload-artifact@v4
        with:
          name: target-artifact
          path: target/*.jar

  # === STAGE 2: TEST UNITARIO ===
  test_unit:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Ejecutar Pruebas Unitarias (mvn test)
        run: mvn test

  # === STAGE 3: TEST DE INTEGRACIÓN ===
  test_integration:
    runs-on: ubuntu-latest
    needs: test_unit
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Ejecutar Pruebas de Integración (mvn verify)
        run: mvn verify

  # === STAGE 4: TEST DE ACEPTACIÓN ===
  acceptance_tests:
    runs-on: ubuntu-latest
    needs: test_integration 
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with: # Asegúrate de que 'with' está indentado correctamente (2 espacios desde 'uses:')
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Ejecutar Pruebas de Aceptación (mvn verify -Pacceptance)
        run: mvn verify -Pacceptance 
      
  # === STAGE 5: DESPLIEGUE EN AMBIENTE DE PRUEBA (Staging) ===
  deploy_staging:
    runs-on: ubuntu-latest
    needs: acceptance_tests 
    environment:
      name: Staging
    
    steps:
      - name: Simular Despliegue (FORZAR FALLO para la evidencia de Rollback)
        run: |
          echo "Iniciando despliegue en ambiente de Staging..."
          echo "Esta ejecución FALLARÁ intencionalmente para demostrar el rollback."
          exit 1 # Comando que fuerza el fallo

  # === STAGE 6: ROLLBACK ===
  rollback_deployment:
    runs-on: ubuntu-latest
    needs: deploy_staging
    if: always() && failure()
    
    steps:
      - name: Simular Ejecución de Rollback
        run: |
          echo "*****************************************************"
          echo "* FALLO EN DESPLIEGUE DETECTADO. EJECUTANDO ROLLBACK  *"
          echo "*****************************************************"
          sleep 5
          echo "Rollback completado. La versión estable anterior está de nuevo en línea."